<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/lazy-imports/lazy-imports-mixin.html">

<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="../gobandgo-loader/gobandgo-loader.html">
<link rel="import" href="../gobandgo-animated-pages/gobandgo-animated-pages.html">

<dom-module id="gobandgo-app">

  <link rel="lazy-import" href="../gobandgo-stage/gobandgo-stage.html" group="stage">
  <link rel="lazy-import" href="../../bower_components/polymerfire/polymerfire.html" group="firebase">
  <link rel="lazy-import" href="../../bower_components/iron-ajax/iron-ajax.html" group="iron-ajax">
  <link rel="lazy-import" href="../../bower_components/app-storage/app-localstorage/app-localstorage-document.html" group="localstorage">

  <template>
    <style>
       :host {
        display: block;
        --app-primary-color: #663399;
        --app-secondary-color: #D4AF37;
        @apply --layout-vertical;
      }

      #pages {
        @apply --layout-flex;
        @apply --layout-vertical;
      }

      .page {
        @apply --layout-flex;
      }

    </style>

    <app-localstorage-document
      data="{{_language}}"
      key="language"
    >
    </app-local-storage-document>

    <iron-ajax
      auto
      url="src/resources/json/firebase-data.json"
      handle-as="json"
      on-response="_handleFirebaseDataResponse"
      on-error="_handleFirebaseDataError"
    ></iron-ajax>

    <iron-ajax
      id="language-ajax"
      auto
      handle-as="json"
      on-response="_handleLanguageDataResponse"
      on-error="_handleLanguageDataError"
    ></iron-ajax>

    <firebase-app
      id="firebase-app"
      name="[[_firebaseAppName]]"
    ></firebase-app>

    <firebase-auth
      id="auth"
      app-name="[[_firebaseAppName]]"
    ></firebase-auth>

    <gobandgo-animated-pages id="pages" selected="[[_page]]" attr-for-selected="name">
      <gobandgo-stage name="stage" class="page" locale="[[_locale]]" on-language-change="_onLanguageChange"></gobandgo-stage>
      <gobandgo-loader name="loader" class="page" exit-animation="slide-up"></gobandgo-loader>
    </gobandgo-animated-pages>

  </template>

  <script>
    class GobandgoApp extends Polymer.LazyImportsMixin(Polymer.Element) {

      static get is() {
        return 'gobandgo-app';
      }

      static get properties() {
        return {
          _page: {
            type: String,
            value: 'loader'
          },
          _firebaseAppName: {
            type: String,
            value: 'gobandgo-firebase',
            readOnly: true
          },
          _language: {
            type: String,
            value: ''
          },
          _locale: Object
        }
      }

      static get observers() {
        return [
          '_updateLocale(_language)'
        ]
      }

      ready() {
        super.ready();
        this.importLazyGroup('iron-ajax');
        this.importLazyGroup('localstorage').then(() => {
          if(!this._language) {
            this._language = 'en';
          }
        });
      }

      _onLanguageChange(evt) {
        const newLang = evt.detail.language;
        this._language = newLang;
      }

      _updateLocale(newLang, oldLang) {

        if(!newLang) {
          return;
        }

        if(newLang == oldLang) {
          return;
        }

        this.$['language-ajax'].url = 'src/resources/json/'+newLang+'.json';

      }

      _handleSignIn() {
        this.$.auth.signInAnonymously()
        .then(() => {
          this._loadStage();
        });
      }

      _loadStage() {
        this.importLazyGroup('stage')
          .then(() => {
            this._page = 'stage';
          });
      }

      _handleFirebaseDataResponse(evt) {
        this.$['firebase-app'].apiKey = evt.detail.response.apiKey;
        this.$['firebase-app'].authDomain = evt.detail.response.authDomain;
        this.$['firebase-app'].databaseUrl = evt.detail.response.databaseURL;

        this.importLazyGroup('firebase')
          .then(() => {
            this._handleSignIn();
          });
      }

      _handleLanguageDataResponse(evt) {
        this._locale = evt.detail.response;
      }

      _handleFirebaseDataError(evt) {
        console.error(evt.detail.response);
      }

      _handleLanguageDataError(evt) {
        console.error(evt.detail.response);
      }
    }

    window.customElements.define(GobandgoApp.is, GobandgoApp);
  </script>
</dom-module>